---
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
import { Fragment } from 'astro/jsx-runtime';
import { resolveImage } from '../utils/resolveImage';
import { nav } from '../data/nav';
import Container from './Container.astro';

interface Props {
  logoVariant?: 'default' | 'black';
  menuHoverVariant?: 'default' | 'secondary';
}

const { logoVariant = 'default', menuHoverVariant = 'default' } = Astro.props;
const hoverText = menuHoverVariant === 'secondary' ? 'hover:text-brand-secondary' : 'hover:text-brand-primary';
const shapeBg = menuHoverVariant === 'secondary' ? 'bg-brand-secondary' : 'bg-brand-primary';
const { items, primaryCta } = nav;
const logoSrc = logoVariant === 'black'
  ? resolveImage('/images/footer-logo-black.png')
  : resolveImage('/images/logo.png');
---

<header class="absolute left-0 right-auto top-0 w-full py-20">
  <div class="relative z-1000 bg-transparent">
    <Container>
      <div class="flex items-center justify-between">
        <a href="/" class="inline-flex items-center gap-10" aria-label="Buildo home">
          <Image
            src={logoSrc as ImageMetadata}
            alt="Buildo"
            class="w-[136px] h-auto"
            loading="eager"
            decoding="async"
            width={136}
            height={48}
          />
        </a>

        <nav
          class="max-991:fixed max-991:inset-y-0 max-991:left-0 max-991:z-40 max-991:h-screen max-991:max-h-screen max-991:w-350 max-991:max-w-full max-991:overflow-auto max-991:bg-surface-white max-991:-translate-x-full max-991:transition-[transform,box-shadow] max-991:duration-[400ms] max-991:ease-in-out max-767:w-300 min-992:static min-992:block min-992:h-auto min-992:w-auto min-992:overflow-visible min-992:bg-transparent min-992:shadow-none min-992:translate-x-0"
          aria-label="Primary"
          id="primary-navigation"
          data-nav
        >
          <ul class="mt-0 mb-0 flex list-none flex-col gap-20 max-991:mx-15 max-991:items-start max-991:justify-start max-991:bg-surface-white max-991:pt-40 max-991:px-20 max-991:pb-45 max-991:overflow-auto max-767:gap-18 max-767:px-10 min-992:flex-row min-992:items-center min-992:justify-between min-992:gap-x-40 min-992:gap-y-35 min-992:pt-0 min-992:px-0 min-992:pb-0 min-992:mx-0">
            <li class="relative mb-0 w-full border-x-0 border-t-0 border-b border-solid border-neutral-350 pb-32 max-991:mb-13 max-991:block min-992:hidden">
              <a href="/" class="inline-flex items-center gap-10" aria-label="Buildo home">
                <Image
                  src={logoSrc as ImageMetadata}
                  alt="Buildo"
                  class="h-36 w-auto"
                  loading="lazy"
                  decoding="async"
                  width={138}
                  height={48}
                />
              </a>
            </li>
            {items.map((item) => (
              <li class="relative mb-0 pl-0">
                {item.children ? (
                  <div class="relative mx-0 group">
                    <button
                      type="button"
                      class:list={["relative flex w-full items-center gap-7 border-0 bg-transparent p-0 font-sans text-nav tracking-nav text-ink-body transition-colors duration-300 min-992:w-auto cursor-pointer focus-visible:outline focus-visible:outline-2 focus-visible:outline-info focus-visible:outline-offset-0 focus-visible:rounded-5", hoverText]}
                      aria-expanded="false"
                      aria-haspopup="true"
                      data-dropdown-toggle
                    >
                      <div class="main-menu-text-block">{item.label}</div>
                      <div class="menu-icon w-14 leading-none">
                        
                        <svg  viewBox="0 0 14 8" class="block h-auto w-14" aria-hidden="true"> <path d="M1 1.5L6 6.5L11 1.5" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path> </svg>
                      </div>
                      <div class:list={["main-menu-border-shape absolute left-1/2 -bottom-5 h-4 w-11 -translate-x-1/2 rounded-100 opacity-0 transition-opacity duration-300 group-hover:opacity-100 max-991:left-0 max-991:translate-x-0", shapeBg]}></div>
                    </button>
                    <div
                      class="hidden max-991:mt-10 min-992:absolute min-992:left-0 min-992:top-full min-992:mt-20 min-992:transition min-992:duration-200"
                      data-dropdown
                    >
                      <div class="min-w-220 bg-surface-white py-20 shadow-[0_4px_20px_rgba(0,0,0,0.1)] max-991:min-w-190 max-767:min-w-195 max-479:min-w-195 rounded-12 max-991:rounded-none min-992:group-hover:rounded-none">
                        <ul class="mt-0 mb-0 flex list-none flex-col">
                          {item.children.map((child) => (
                            <li>
                              <a
                                href={child.href}
                                class:list={["block px-30 py-5 text-button text-ink-body transition-all duration-300 hover:pl-35 focus-visible:outline focus-visible:outline-2 focus-visible:outline-info focus-visible:outline-offset-0 focus-visible:rounded-5 max-767:px-20 max-767:hover:pl-25 max-767:hover:pr-25", hoverText]}
                                target={child.external ? '_blank' : undefined}
                                rel={child.external ? 'noreferrer' : undefined}
                              >
                                {child.label}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  </div>
                ) : (
                  <a
                    href={item.href}
                    class:list={["font-sans text-nav tracking-button text-ink-body transition-colors duration-300", hoverText]}
                    target={item.external ? '_blank' : undefined}
                    rel={item.external ? 'noreferrer' : undefined}
                  >
                    {item.label}
                  </a>
                )}
              </li>
            ))}
            <li class="mt-10 w-full border-x-0 border-b-0 border-t border-solid border-neutral-350 pt-37 text-left min-992:hidden">
              <a
                href={primaryCta.href}
                class="inline-flex items-center justify-center bg-ink-body px-24 py-12 text-button text-surface-white transition hover:bg-brand-primary"
              >
                {primaryCta.label}
              </a>
            </li>
          </ul>
        </nav>

        <div class="fixed inset-0 z-30 bg-black/20 opacity-0 pointer-events-none transition-opacity duration-[400ms] ease-in-out min-992:hidden" data-nav-overlay></div>

        <div class="hidden min-992:block">
          <a
            href={primaryCta.href}
            class="inline-flex items-center justify-center bg-ink-body px-24 py-12 text-button text-surface-white transition hover:bg-brand-primary"
          >
            {primaryCta.label}
          </a>
        </div>

        <div class="menu-button p-0 min-992:hidden">
          <button
            type="button"
            class="icon-mobile-menu flex h-45 w-45 cursor-pointer select-none items-center justify-center border-0 bg-transparent p-0 text-ink-body transition-colors duration-300 hover:text-brand-primary"
            aria-label="Toggle navigation"
            aria-expanded="false"
            aria-controls="primary-navigation"
            data-nav-toggle
          >
            <svg viewBox="0 0 64 64" class="h-45 w-45" aria-hidden="true">
              <line x1="12" y1="21" x2="52" y2="21" stroke="currentColor" stroke-width={2} />
              <line x1="12" y1="33" x2="52" y2="33" stroke="currentColor" stroke-width={2} />
              <line x1="12" y1="45" x2="52" y2="45" stroke="currentColor" stroke-width={2} />
            </svg>
          </button>
        </div>
      </div>
    </Container>
  </div>
</header>

<script>
  const navToggle = document.querySelector('[data-nav-toggle]');
  const navMenu = document.querySelector('[data-nav]');
  const navOverlay = document.querySelector('[data-nav-overlay]');
  const dropdownToggles = Array.from(
    document.querySelectorAll('[data-dropdown-toggle]')
  );

  const closeDropdowns = () => {
    dropdownToggles.forEach((toggle) => {
      toggle.setAttribute('aria-expanded', 'false');
      const menu = toggle.nextElementSibling;
      if (menu && menu.hasAttribute('data-dropdown')) {
        menu.classList.add('hidden');
      }
    });
  };

  const openNav = () => {
    navMenu?.classList.add('nav-open');
    navOverlay?.classList.add('nav-overlay-visible');
    navToggle?.setAttribute('aria-expanded', 'true');
  };

  const closeNav = () => {
    navMenu?.classList.remove('nav-open');
    navOverlay?.classList.remove('nav-overlay-visible');
    navToggle?.setAttribute('aria-expanded', 'false');
  };

  navToggle?.addEventListener('click', () => {
    const isOpen = navMenu?.classList.contains('nav-open');
    if (isOpen) {
      closeNav();
    } else {
      openNav();
    }
  });

  navOverlay?.addEventListener('click', () => {
    closeNav();
    closeDropdowns();
  });

  dropdownToggles.forEach((toggle) => {
    toggle.addEventListener('click', (event) => {
      event.stopPropagation();
      const menu = toggle.nextElementSibling;
      if (!menu || !menu.hasAttribute('data-dropdown')) return;
      const isOpen = !menu.classList.contains('hidden');
      closeDropdowns();
      if (!isOpen) {
        menu.classList.remove('hidden');
        toggle.setAttribute('aria-expanded', 'true');
      }
    });

    toggle.addEventListener('keydown', (e) => {
      const menu = toggle.nextElementSibling;
      if (!menu || !menu.hasAttribute('data-dropdown')) return;
      const links = Array.from(menu.querySelectorAll('a')) as HTMLElement[];
      if (!links.length) return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        if (menu.classList.contains('hidden')) {
          menu.classList.remove('hidden');
          toggle.setAttribute('aria-expanded', 'true');
        }
        links[0]?.focus();
      }
    });
  });

  document.addEventListener('keydown', (e) => {
    const active = document.activeElement as HTMLElement;
    const dropdown = active?.closest('[data-dropdown]');
    if (!dropdown) return;
    const links = Array.from(dropdown.querySelectorAll('a')) as HTMLElement[];
    const index = links.indexOf(active);
    if (index < 0) return;

    if (e.key === 'ArrowDown') {
      e.preventDefault();
      links[(index + 1) % links.length]?.focus();
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      links[(index - 1 + links.length) % links.length]?.focus();
    } else if (e.key === 'Home') {
      e.preventDefault();
      links[0]?.focus();
    } else if (e.key === 'End') {
      e.preventDefault();
      links[links.length - 1]?.focus();
    }
  });

  document.addEventListener('click', () => {
    closeDropdowns();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      const isNavOpen = navMenu?.classList.contains('nav-open');
      if (isNavOpen) {
        closeNav();
        closeDropdowns();
        (navToggle as HTMLElement)?.focus();
      } else {
        closeDropdowns();
      }
    }
  });
</script>



