---
import Container from './Container.astro';
import TeamCardTwo from './TeamCardTwo.astro';
import { team } from '../data/team';
import { settings } from '../data/settings';

const { items } = team;
const { socials } = settings;
const perPage = 6;
const totalPages = Math.ceil(items.length / perPage);

// Process items to extract string URLs from ImageMetadata objects
const processedItems = items.map(item => ({
  ...item,
  image: {
    src: typeof item.image.src === 'string' ? item.image.src : item.image.src.src,
    alt: item.image.alt
  }
}));
---

<section class="pt-100 pb-100 max-991:pt-80 max-991:pb-80 max-767:pt-60 max-767:pb-60">
  <Container>
    <div id="team-grid" class="grid grid-cols-3 gap-30 max-991:grid-cols-2 max-479:grid-cols-1">
      {items.map((member, index) => (
        <div
          class="reveal"
          data-team-card
          data-page={Math.floor(index / perPage)}
          style={index >= perPage ? 'display:none' : ''}
        >
          <TeamCardTwo {...member} index={index} />
        </div>
      ))}
    </div>

    <div class="pagination-wrap mt-50 flex justify-center gap-10 max-991:mt-40 max-767:mt-30">
      <button
        type="button"
        id="team-prev-btn"
        class="inline-flex cursor-pointer items-center gap-5 rounded-50 border-0 bg-brand-secondary px-22 py-10 text-[18px] leading-[1em] text-surface-white transition-colors duration-300 hover:bg-brand-primary"
        aria-label="Previous page"
        style="display:none"
      >
        <div class="pagination-icon relative mt-2 h-[1em] w-16">
          <svg viewBox="0 0 16 16" fill="none" class="h-16 w-16" aria-hidden="true">
            <path
              d="M9.62012 3.95331L13.6668 7.99998L9.62012 12.0466"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-miterlimit="10"
              stroke-linecap="round"
              stroke-linejoin="round"
              transform="rotate(180 8 8)"></path>
            <path
              d="M2.33325 8H13.5533"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-miterlimit="10"
              stroke-linecap="round"
              stroke-linejoin="round"
              transform="rotate(180 8 8)"></path>
          </svg>
        </div>
        Previous
      </button>
      <button
        type="button"
        id="team-next-btn"
        class="inline-flex cursor-pointer items-center gap-5 rounded-50 border-0 bg-brand-secondary px-22 py-10 text-[18px] leading-[1em] text-surface-white transition-colors duration-300 hover:bg-brand-primary"
        aria-label="Next page"
      >
        Next
        <div class="pagination-icon relative mt-2 h-[1em] w-16">
          <svg viewBox="0 0 16 16" fill="none" class="h-16 w-16" aria-hidden="true">
            <path
              d="M9.62012 3.95331L13.6668 7.99998L9.62012 12.0466"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-miterlimit="10"
              stroke-linecap="round"
              stroke-linejoin="round"></path>
            <path
              d="M2.33325 8H13.5533"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-miterlimit="10"
              stroke-linecap="round"
              stroke-linejoin="round"></path>
          </svg>
        </div>
      </button>
    </div>
  </Container>

  <div
    class="fixed inset-0 z-50 hidden items-center justify-center bg-ink-body/80 px-20 py-40"
    data-team-modal
    aria-hidden="true"
  >
    <div
      class="relative w-full max-w-[960px] rounded-8 bg-surface-white p-80 mx-15 max-767:p-[50px_30px] max-479:pb-30 max-479:pr-20"
      role="dialog"
      aria-modal="true"
      aria-labelledby="team-modal-title"
      aria-describedby="team-modal-bio"
    >
      <button
        type="button"
        class="absolute -top-[3%] -right-[1%] inline-flex h-40 w-40 cursor-pointer items-center justify-center rounded-full border-0 bg-brand-primary text-surface-white transition-colors duration-300 hover:bg-brand-secondary max-991:right-[-2%] max-767:right-[-1%]"
        aria-label="Close modal"
        data-team-close
      >
        X
      </button>

      <div class="max-479:h-[500px] max-479:overflow-auto max-479:pb-20 max-479:pr-10">
      <div class="grid grid-cols-[4fr_8fr] gap-30 max-767:grid-cols-[5fr_7fr] max-479:grid-cols-1 max-479:gap-20">
        <div class="overflow-hidden">
          <img
            data-team-image
            src=""
            alt="Team member profile"
            class="h-[398px] w-[320px] rounded-8 object-cover max-479:w-full"
            loading="lazy"
            decoding="async"
            width="320"
            height="398"
          />
        </div>
        <div>
          <div class="flex items-end justify-between gap-20 max-479:block">
            <div>
              <h3 id="team-modal-title" class="mb-[6px] text-[32px] leading-[1] tracking-[0.32px] text-ink-heading max-479:text-[24px] max-479:leading-[34.4px]" data-team-name></h3>
              <div class="tracking-[-0.18px] text-ink-body" data-team-role></div>
            </div>
            <div class="flex items-center gap-9 max-479:mt-10" data-team-socials>
              <a
                class="inline-flex h-32 w-32 items-center justify-center rounded-full bg-brand-secondary text-surface-white transition-colors duration-300 hover:bg-brand-primary"
                href={socials.facebook}
                data-social="facebook"
                aria-label="Facebook"
              >
                <svg viewBox="0 0 8 14" class="h-14 w-8" aria-hidden="true">
                  <path
                    d="M2.46297 7.83206C2.41497 7.83206 1.35897 7.83206 0.878969 7.83206C0.622969 7.83206 0.542969 7.73606 0.542969 7.49606C0.542969 6.85606 0.542969 6.20006 0.542969 5.56006C0.542969 5.30406 0.638969 5.22406 0.878969 5.22406H2.46297C2.46297 5.17606 2.46297 4.24806 2.46297 3.81606C2.46297 3.17606 2.57497 2.56806 2.89497 2.00806C3.23097 1.43206 3.71097 1.04806 4.31897 0.824058C4.71897 0.680058 5.11897 0.616058 5.55097 0.616058H7.11897C7.34297 0.616058 7.43897 0.712058 7.43897 0.936058V2.76006C7.43897 2.98406 7.34297 3.08006 7.11897 3.08006C6.68697 3.08006 6.25497 3.08006 5.82297 3.09606C5.39097 3.09606 5.16697 3.30406 5.16697 3.75206C5.15097 4.23206 5.16697 4.69606 5.16697 5.19206H7.02297C7.27897 5.19206 7.37497 5.28806 7.37497 5.54406V7.48006C7.37497 7.73606 7.29497 7.81606 7.02297 7.81606C6.44697 7.81606 5.21497 7.81606 5.16697 7.81606V13.0321C5.16697 13.3041 5.08697 13.4001 4.79897 13.4001C4.12697 13.4001 3.47097 13.4001 2.79897 13.4001C2.55897 13.4001 2.46297 13.3041 2.46297 13.0641C2.46297 11.3841 2.46297 7.88006 2.46297 7.83206Z"
                    fill="currentColor"
                  />
                </svg>
              </a>
              <a
                class="inline-flex h-32 w-32 items-center justify-center rounded-full bg-brand-secondary text-surface-white transition-colors duration-300 hover:bg-brand-primary"
                href={socials.instagram}
                data-social="instagram"
                aria-label="Instagram"
              >
                <svg viewBox="0 0 14 14" class="h-14 w-14" aria-hidden="true">
                  <path d="M6.99221 4.55472C5.64288 4.55472 4.54688 5.65072 4.54688 7.00005C4.54688 8.34938 5.64288 9.44805 6.99221 9.44805C8.34154 9.44805 9.44021 8.34938 9.44021 7.00005C9.44021 5.65072 8.34154 4.55472 6.99221 4.55472Z" fill="currentColor" />
                  <path d="M10.6855 0.333374H3.30413C1.66413 0.333374 0.328125 1.66937 0.328125 3.30937V10.6907C0.328125 12.3334 1.66413 13.6667 3.30413 13.6667H10.6855C12.3281 13.6667 13.6615 12.3334 13.6615 10.6907V3.30937C13.6615 1.66937 12.3281 0.333374 10.6855 0.333374ZM6.99479 11.32C4.61346 11.32 2.67479 9.38138 2.67479 7.00004C2.67479 4.61871 4.61346 2.68271 6.99479 2.68271C9.37613 2.68271 11.3148 4.61871 11.3148 7.00004C11.3148 9.38138 9.37613 11.32 6.99479 11.32ZM11.4055 3.46671C10.9015 3.46671 10.4908 3.05871 10.4908 2.55471C10.4908 2.05071 10.9015 1.64004 11.4055 1.64004C11.9095 1.64004 12.3201 2.05071 12.3201 2.55471C12.3201 3.05871 11.9095 3.46671 11.4055 3.46671Z" fill="currentColor" />
                </svg>
              </a>
              <a
                class="inline-flex h-32 w-32 items-center justify-center rounded-full bg-brand-secondary text-surface-white transition-colors duration-300 hover:bg-brand-primary"
                href={socials.twitter}
                data-social="twitter"
                aria-label="Twitter"
              >
                <svg viewBox="0 0 16 14" class="h-14 w-16" aria-hidden="true">
                  <path d="M16 2.03906C15.405 2.30006 14.771 2.47306 14.11 2.55706C14.79 2.15106 15.309 1.51306 15.553 0.744061C14.919 1.12206 14.219 1.38906 13.473 1.53806C12.871 0.897061 12.013 0.500061 11.077 0.500061C9.261 0.500061 7.799 1.97406 7.799 3.78106C7.799 4.04106 7.821 4.29106 7.875 4.52906C5.148 4.39606 2.735 3.08906 1.114 1.09806C0.831 1.58906 0.665 2.15106 0.665 2.75606C0.665 3.89206 1.25 4.89906 2.122 5.48206C1.595 5.47206 1.078 5.31906 0.64 5.07806C0.64 5.08806 0.64 5.10106 0.64 5.11406C0.64 6.70806 1.777 8.03206 3.268 8.33706C3.001 8.41006 2.71 8.44506 2.408 8.44506C2.198 8.44506 1.986 8.43306 1.787 8.38906C2.212 9.68806 3.418 10.6431 4.852 10.6741C3.736 11.5471 2.319 12.0731 0.785 12.0731C0.516 12.0731 0.258 12.0611 0 12.0281C1.453 12.9651 3.175 13.5001 5.032 13.5001C11.068 13.5001 14.368 8.50006 14.368 4.16606C14.368 4.02106 14.363 3.88106 14.356 3.74206C15.007 3.28006 15.554 2.70306 16 2.03906Z" fill="currentColor" />
                </svg>
              </a>
            </div>
          </div>
          <div class="my-23 border-t border-b border-solid border-l-0 border-r-0 border-neutral-200 py-22">
            <h4 class="mb-13 text-[20px] leading-[30px] tracking-[-0.2px] text-ink-heading">
              About Me
            </h4>
            <p id="team-modal-bio" class="mb-0 text-body text-ink-body" data-team-bio></p>
          </div>
          <div class="grid grid-cols-2 gap-22 max-479:grid-cols-1" data-team-skills></div>
        </div>
      </div>
      </div>
    </div>
  </div>
</section>

<script is:inline define:vars={{ data: processedItems }}>
  // Team modal data is available via define:vars
  const modal = document.querySelector('[data-team-modal]');
  const closeBtn = document.querySelector('[data-team-close]');
  const nameEl = document.querySelector('[data-team-name]');
  const roleEl = document.querySelector('[data-team-role]');
  const bioEl = document.querySelector('[data-team-bio]');
  const imageEl = document.querySelector('[data-team-image]');
  const socialsEl = document.querySelector('[data-team-socials]');
  const skillsEl = document.querySelector('[data-team-skills]');

  let lastFocused = null;

  const trapFocus = (event) => {
    if (event.key !== 'Tab') return;
    const focusable = modal.querySelectorAll(
      'a[href], button:not([disabled]), textarea, input, select, [tabindex]:not([tabindex="-1"])'
    );
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (!first || !last) return;
    if (event.shiftKey && document.activeElement === first) {
      event.preventDefault();
      last.focus();
    } else if (!event.shiftKey && document.activeElement === last) {
      event.preventDefault();
      first.focus();
    }
  };

  const openModal = (index) => {
    const member = data[index];
    if (!member) return;
    lastFocused = document.activeElement;
    if (nameEl) nameEl.textContent = member.name;
    if (roleEl) roleEl.textContent = member.role;
    if (bioEl) bioEl.textContent = member.bio || 'A dedicated team member contributing to our success.';
    if (imageEl && member.image) {
      imageEl.src = member.image.src || '';
      imageEl.alt = member.image.alt || member.name;
    }

    socialsEl.querySelectorAll('[data-social]').forEach((link) => {
      const key = link.getAttribute('data-social');
      link.href = member.socials[key] || link.href || '#';
    });

    skillsEl.innerHTML = '';
    member.skills.forEach((skill) => {
      const row = document.createElement('div');
      row.innerHTML = `
        <div class="flex items-center justify-between mb-7">
          <span class="text-[16px] leading-[24px] text-ink-body">${skill.label}</span>
          <span class="text-[15px] font-semibold text-brand-secondary">${skill.value}</span>
        </div>
        <div class="h-[6px] w-full rounded-full bg-neutral-200">
          <div class="h-[6px] rounded-full bg-brand-secondary" style="width: ${skill.value}"></div>
        </div>
      `;
      skillsEl.appendChild(row);
    });

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.setAttribute('aria-hidden', 'false');
    document.querySelector('main')?.setAttribute('aria-hidden', 'true');
    closeBtn?.focus();
    document.addEventListener('keydown', trapFocus);
  };

  const closeModal = () => {
    modal.classList.remove('flex');
    modal.classList.add('hidden');
    modal.setAttribute('aria-hidden', 'true');
    document.querySelector('main')?.removeAttribute('aria-hidden');
    document.removeEventListener('keydown', trapFocus);
    if (lastFocused) lastFocused.focus();
  };

  document.querySelectorAll('[data-team-open]').forEach((button) => {
    button.addEventListener('click', () => {
      openModal(Number(button.getAttribute('data-team-open')));
    });
  });

  closeBtn?.addEventListener('click', closeModal);
  modal?.addEventListener('click', (event) => {
    if (event.target === modal) closeModal();
  });

  document.addEventListener('keydown', (event) => {
    if (event.key === 'Escape') closeModal();
  });
</script>

<script define:vars={{ totalPages }}>
  const teamCards = document.querySelectorAll('[data-team-card]');
  const teamPrevBtn = document.getElementById('team-prev-btn');
  const teamNextBtn = document.getElementById('team-next-btn');
  let teamCurrentPage = 0;

  function showTeamPage(page) {
    teamCards.forEach((card) => {
      const cardPage = parseInt(card.getAttribute('data-page'));
      card.style.display = cardPage === page ? '' : 'none';
    });

    teamPrevBtn.style.display = page > 0 ? '' : 'none';
    teamNextBtn.style.display = page < totalPages - 1 ? '' : 'none';
  }

  teamPrevBtn.addEventListener('click', () => {
    if (teamCurrentPage > 0) {
      teamCurrentPage--;
      showTeamPage(teamCurrentPage);
      window.scrollTo({ top: document.getElementById('team-grid').offsetTop - 100, behavior: 'smooth' });
    }
  });

  teamNextBtn.addEventListener('click', () => {
    if (teamCurrentPage < totalPages - 1) {
      teamCurrentPage++;
      showTeamPage(teamCurrentPage);
      window.scrollTo({ top: document.getElementById('team-grid').offsetTop - 100, behavior: 'smooth' });
    }
  });

  showTeamPage(0);
</script>
